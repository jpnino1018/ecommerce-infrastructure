trigger:
  branches:
    include:
      - main
      - stage
      - develop

pool:
  name: my-machine

variables:
  rm-rg-name: 'rg-terraform-state'
  rm-account-name: 'ecommerceinfrastrgacc'
  rm-container-name: 'tfstate'

stages:

# === DEV STAGE ===
- stage: Terraform_Dev
  displayName: "Terraform Deploy - Dev"
  condition: eq(variables['Build.SourceBranchName'], 'develop')
  jobs:
    - job: Deploy_Dev
      displayName: "Deploy Dev Environment"
      steps:
        - checkout: self
          clean: true

        - task: AzureCLI@2
          inputs:
            azureSubscription: 'azure-connection'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az account show --output table
          displayName: "üîç Check Azure Subscription"

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/dev'
            backendServiceArm: 'azure-connection'
            backendAzureRmResourceGroupName: '$(rm-rg-name)'
            backendAzureRmStorageAccountName: '$(rm-account-name)'
            backendAzureRmContainerName: '$(rm-container-name)'
            backendAzureRmKey: 'dev.terraform.tfstate'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/dev'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/dev'
            environmentServiceNameAzureRM: 'azure-connection'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/dev'
            environmentServiceNameAzureRM: 'azure-connection'

# === STAGE STAGE ===
- stage: Terraform_Stage
  displayName: "Terraform Deploy - Stage"
  condition: eq(variables['Build.SourceBranchName'], 'stage')
  jobs:
    - job: Deploy_Stage
      displayName: "Deploy Stage Environment"
      steps:
        - checkout: self
          clean: true

        - task: AzureCLI@2
          inputs:
            azureSubscription: 'azure-connection'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az account show --output table
          displayName: "üîç Check Azure Subscription"

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/stage'
            backendServiceArm: 'azure-connection'
            backendAzureRmResourceGroupName: '$(rm-rg-name)'
            backendAzureRmStorageAccountName: '$(rm-account-name)'
            backendAzureRmContainerName: '$(rm-container-name)'
            backendAzureRmKey: 'stage.terraform.tfstate'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/stage'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/stage'
            environmentServiceNameAzureRM: 'azure-connection'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/stage'
            environmentServiceNameAzureRM: 'azure-connection'

# === PROD STAGE ===
- stage: Terraform_Prod
  displayName: "Terraform Deploy - Prod"
  condition: eq(variables['Build.SourceBranchName'], 'main')
  jobs:
    - job: Deploy_Prod
      displayName: "Deploy Prod Environment"
      steps:
        - checkout: self
          clean: true
          
        - task: AzureCLI@2
          inputs:
            azureSubscription: 'azure-connection'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              $accountName = "ecommerceinfrastrgacc"
              $containerName = "tfstate"
              $resourceGroup = "rg-terraform-state"

              Write-Host "`nüîé Getting storage account key (fallback method for debugging)..."

              $key = az storage account keys list --account-name $accountName --resource-group $resourceGroup --query "[0].value" -o tsv
              if (-not $key) {
                Write-Host "‚ùå Failed to retrieve storage account key."
                exit 1
              }

              Write-Host "‚úÖ Got key (truncated): $($key.Substring(0, 5))..."

              Write-Host "`nüì¶ Testing key-based blob access:"
              $keyAccess = az storage blob list `
                --account-name $accountName `
                --container-name $containerName `
                --account-key $key `
                --only-show-errors

              if (-not $keyAccess) {
                Write-Host "‚ùå Key-based blob listing failed."
                exit 1
              } else {
                Write-Host "‚úÖ Key-based blob listing successful."
              }

              Write-Host "`nüîê Testing Azure AD-based blob access (login mode):"
              try {
                $aadAccess = az storage blob list `
                  --account-name $accountName `
                  --container-name $containerName `
                  --auth-mode login `
                  --only-show-errors

                Write-Host "‚úÖ Azure AD access successful"
              } catch {
                Write-Host "‚ùå Azure AD access FAILED"
                Write-Host $_.Exception.Message
                exit 1
              }



        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/prod'
            backendServiceArm: 'azure-connection'
            backendAzureRmResourceGroupName: '$(rm-rg-name)'
            backendAzureRmStorageAccountName: '$(rm-account-name)'
            backendAzureRmContainerName: '$(rm-container-name)'
            backendAzureRmKey: 'prod.terraform.tfstate'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/prod'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/prod'
            environmentServiceNameAzureRM: 'azure-connection'

        - task: TerraformTask@5
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/envs/prod'
            environmentServiceNameAzureRM: 'azure-connection'
