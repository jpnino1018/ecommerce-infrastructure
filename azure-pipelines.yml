trigger:
  branches:
    include:
      - main  # Adjust as needed

parameters:
  - name: environment
    displayName: Environment to deploy
    type: string
    default: dev
    values:
      - dev
      - stage
      - prod

pool:
  name: my-machine

variables:
  TF_IN_AUTOMATION: true

stages:
  - stage: Deploy
    displayName: Deploy ${{ parameters.environment }} environment
    jobs:
      - job: Terraform_Deployment
        displayName: Terraform Deployment
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                Write-Host "🔧 Initializing Terraform for ${{ parameters.environment }}..."
                terraform init -backend-config="key=${{ parameters.environment }}.tfstate" .\envs\${{ parameters.environment }}

                Write-Host "🔍 Validating Terraform for ${{ parameters.environment }}..."
                terraform validate .\envs\${{ parameters.environment }}

                Write-Host "🧠 Planning Terraform for ${{ parameters.environment }}..."
                terraform plan -out=tfplan -input=false -var="env=${{ parameters.environment }}" .\envs\${{ parameters.environment }}

                Write-Host "🚀 Applying Terraform plan for ${{ parameters.environment }}..."
                terraform apply -input=false tfplan

                Write-Host "✅ Deployment for ${{ parameters.environment }} completed!"
            displayName: 'Run Terraform with PowerShell'
