trigger:
  branches:
    include:
      - main  # Adjust as needed

parameters:
  - name: environment
    displayName: Environment to deploy
    type: string
    default: dev
    values:
      - dev
      - stage
      - prod

pool:
  name: my-machine

variables:
  TF_IN_AUTOMATION: true

stages:
  - stage: Deploy
    displayName: Deploy ${{ parameters.environment }} environment
    jobs:
      - job: Terraform_Deployment
        displayName: Terraform Deployment
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $envDir = "envs/${{ parameters.environment }}"
                Set-Location $envDir

                Write-Host "ğŸ”§ Initializing Terraform for ${{ parameters.environment }}..."
                terraform init -backend-config="key=${{ parameters.environment }}.tfstate"

                Write-Host "ğŸ” Validating Terraform for ${{ parameters.environment }}..."
                terraform validate

                Write-Host "ğŸ§  Planning Terraform for ${{ parameters.environment }}..."
                terraform plan -out=tfplan -input=false -var="env=${{ parameters.environment }}"

                Write-Host "ğŸš€ Applying Terraform plan for ${{ parameters.environment }}..."
                terraform apply -input=false tfplan

                Write-Host "âœ… Deployment for ${{ parameters.environment }} completed!"
            displayName: 'Run Terraform with PowerShell'

