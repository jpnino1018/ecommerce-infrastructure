trigger:
  branches:
    include:
      - main  # Adjust as needed

parameters:
  - name: environment
    displayName: Environment to deploy
    type: string
    default: dev
    values:
      - dev
      - stage
      - prod

pool:
  name: my-machine

variables:
  TF_IN_AUTOMATION: true

stages:
  - stage: Deploy
    displayName: Deploy ${{ parameters.environment }} environment
    jobs:
      - job: Terraform_Deployment
        displayName: Terraform Deployment
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $env = "${{ parameters.environment }}"
                $envDir = "$(System.DefaultWorkingDirectory)\envs\$env"

                Write-Host "Switching to environment directory: $envDir"
                Set-Location $envDir

                Write-Host "ðŸ”§ Running terraform init..."
                terraform init -backend-config="key=$env.tfstate"

                if ($LASTEXITCODE -ne 0) {
                  Write-Error "terraform init failed"
                  exit 1
                }

                Write-Host "Running terraform validate..."
                terraform validate
                if ($LASTEXITCODE -ne 0) {
                  Write-Error "terraform validate failed"
                  exit 1
                }

                Write-Host "Running terraform plan..."
                terraform plan -input=false -var="env=$env" -out=tfplan
                if ($LASTEXITCODE -ne 0) {
                  Write-Error "terraform plan failed"
                  exit 1
                }

                Write-Host "Running terraform apply..."
                terraform apply -input=false tfplan
                if ($LASTEXITCODE -ne 0) {
                  Write-Error "terraform apply failed"
                  exit 1
                }

                Write-Host "Terraform deployment for $env completed successfully!"
            displayName: 'Terraform Deploy with PowerShell'


