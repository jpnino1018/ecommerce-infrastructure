trigger: none
pr: none

parameters:
  - name: environment
    displayName: 'Selecciona un entorno'
    type: string
    default: dev
    values:
      - dev
      - stage
      - prod

    
stages:
  - stage: TerraformDeploy
    displayName: 'Terraform en ${{ parameters.environment }}'
    jobs:
      - job: apply
        displayName: 'Deploy ${{ parameters.environment }}'
        pool:
          name: my-machine 
        steps:
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: 'envs/${{ parameters.environment }}'
              backendServiceArm: 'azure-connection'
              backendAzureRmResourceGroupName: 'tfstate-rg'
              backendAzureRmStorageAccountName: 'tfstateaccicesi'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'dev.terraform.tfstate'
          
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: 'terraform/envs/${{ parameters.environment }}'
              environmentServiceNameAzureRM: 'azure-connection'
              
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: 'envs/${{ parameters.environment }}'
              environmentServiceNameAzureRM: 'azure-connection'
              
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: 'envs/${{ parameters.environment }}'
              environmentServiceNameAzureRM: 'azure-connection'