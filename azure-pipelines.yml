trigger:
  branches:
    include:
      - main

parameters:
  - name: environment
    displayName: Environment to deploy
    type: string
    default: dev
    values:
      - dev
      - stage
      - prod

pool:
  name: my-machine

variables:
  TF_IN_AUTOMATION: true

stages:
  - stage: Deploy
    jobs:
      - job: Terraform_Deployment
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
              addToPath: true

          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.6.6'

          - script: |
              echo "##[section]ğŸ”§ Initializing Terraform..."
              terraform init -backend-config="key=${{ parameters.environment }}.tfstate" ./envs/${{ parameters.environment }}
            displayName: 'Terraform Init'

          - script: |
              echo "##[section]ğŸ” Validating Terraform..."
              terraform validate ./envs/${{ parameters.environment }}
            displayName: 'Terraform Validate'

          - script: |
              echo "##[section]ğŸ§  Planning Terraform..."
              terraform plan -out=tfplan -input=false -var="env=${{ parameters.environment }}" ./envs/${{ parameters.environment }}
            displayName: 'Terraform Plan'

          - script: |
              echo "##[section]ğŸš€ Applying Terraform..."
              terraform apply -input=false tfplan
            displayName: 'Terraform Apply'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "âœ… Infrastructure for ${{ parameters.environment }} deployed!"
            displayName: 'âœ… Post-deployment Confirmation'
