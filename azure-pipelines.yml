trigger:
  branches:
    include:
      - main

pool:
  name: my-machine

variables:
  environment: dev
  envDir: '$(System.DefaultWorkingDirectory)/envs/$(environment)'

steps:
  - checkout: self

  - task: AzureCLI@2
    displayName: 'Terraform Deploy - $(environment)'
    inputs:
      azureSubscription: 'azure-connection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        $envName = "$(environment)"
        $envDir = "$(envDir)"

        Write-Host "Starting Terraform deployment for environment: $envName"
        Set-Location $envDir

        Write-Host "Initializing Terraform..."
        terraform init -backend-config="key=$envName.tfstate"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "terraform init failed"
          exit 1
        }

        Write-Host "Validating Terraform..."
        terraform validate
        if ($LASTEXITCODE -ne 0) {
          Write-Error "terraform validate failed"
          exit 1
        }

        Write-Host "Planning Terraform..."
        terraform plan -input=false -var="env=$envName" -out=tfplan
        if ($LASTEXITCODE -ne 0) {
          Write-Error "terraform plan failed"
          exit 1
        }

        Write-Host "Applying Terraform..."
        terraform apply -input=false tfplan
        if ($LASTEXITCODE -ne 0) {
          Write-Error "terraform apply failed"
          exit 1
        }

        Write-Host "Terraform deployment for $envName completed successfully!"
